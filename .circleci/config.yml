version: 2.1
orbs:
  android: circleci/android@x.y.z
  aws-device-farm: circleci/aws-device-farm@1.0.0
jobs:
  build-and-test:
    executor:
      name: android/android-machine
      resource-class: large
    steps:
      - checkout
      - run: echo "Build your app here"
      # Create an AVD named "myavd"
      - android/create-avd:
          avd-name: myavd
          system-image: system-images;android-29;default;x86
          install: true
      # Start the emulator in the background
      - android/start-emulator:
          avd-name: myavd
          no-window: true
          background: true
      # Run tests on the emulator using AWS Device Farm
      - aws-device-farm/upload:
          project-name: MyProject
          device-pool-arn: ${{ secrets.DEVICE_POOL_ARN }}
          app-path: app/build/outputs/apk/debug/app-debug.apk
          test-path: app/build/outputs/apk/androidTest/debug/app-debug-androidTest.apk
          device-arn: ${{ secrets.DEVICE_ARN }}
          region: ${{ secrets.AWS_REGION }}
          upload-type: ANDROID_APP_AND_TEST
          # Additional options can be specified here, such as test-parameters and environment-variables
workflows:
  build-and-test:
    jobs:
      - build-and-test
